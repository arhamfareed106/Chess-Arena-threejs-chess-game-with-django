import{j as e}from"./three-BQE6C20b.js";import{r as d}from"./vendor-CnEhrtKZ.js";import{a as W,u as _,n as z}from"./index-Cx1_nSxO.js";import{G as D}from"./GameScene-CFPaSG5E.js";import{P as $}from"./index-DpsEWzRx.js";import{g as K}from"./gameService-CS8lbNSt.js";import{a as t,d as O,B as l,t as v,f as p,o as Q,K as U,M as q,N as H,O as J,Q as V,U as Z,W as w}from"./ui-Cda-PtV-.js";const le=()=>{const{gameId:y}=W(),b=_(),[m,C]=d.useState(null),[r,M]=d.useState([]),[R,N]=d.useState([]),[X,Y]=d.useState(!0),[n,u]=d.useState(0),[f,j]=d.useState(!1),[g,T]=d.useState(1e3);d.useEffect(()=>{if(!y)return;(async()=>{try{const s=await K.getGameReplay(y);C({id:s.game_id,name:`Replay of ${s.game_id.slice(0,8)}`,players:s.players,moves:s.moves,winner:s.winner,createdAt:s.created_at,finishedAt:s.finished_at}),M(s.moves||[]),P(s.players)}catch(s){console.error("Failed to load replay data:",s),z.error("Failed to load replay"),b("/")}finally{Y(!1)}})()},[y,b]),d.useEffect(()=>{if(!f||n>=r.length){j(!1);return}const a=setTimeout(()=>{k()},g);return()=>clearTimeout(a)},[f,n,r.length,g]),d.useEffect(()=>{B(n)},[n,r]);const P=a=>{const s=[];a.forEach((o,i)=>{const h=i===0?1:6;for(let c=0;c<8;c++)s.push({id:`${o.id}-piece-${c}`,pieceType:$.TALENT,level:1,positionX:c,positionY:h,transformCount:0,temporaryBuffs:{},isActive:!0,ownerName:o.name,ownerColor:o.color,createdAt:"",updatedAt:""})}),N(s)},B=a=>{if(a===0){m!=null&&m.players&&P(m.players);return}N(s=>{const o=[...s],i=r[a-1];if(i){const h=o.findIndex(c=>c.positionX===i.fromX&&c.positionY===i.fromY);if(h!==-1&&i.toX!==null&&i.toY!==null){const c=o.findIndex(I=>I.positionX===i.toX&&I.positionY===i.toY);c!==-1&&o.splice(c,1),o[h]={...o[h],positionX:i.toX,positionY:i.toY}}}return o})},E=()=>{j(!f)},k=()=>{n<r.length&&u(a=>a+1)},A=()=>{n>0&&u(a=>a-1)},G=()=>{u(0),j(!1)},L=(a,s)=>{u(s),j(!1)},S=()=>{b("/")};if(X)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"loading-spinner mx-auto mb-4"}),e.jsx(t,{variant:"h6",className:"text-white",children:"Loading replay..."})]})});if(!m||r.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(t,{variant:"h5",className:"mb-4",children:"No replay data available"}),e.jsx(O,{onClick:S,children:"Return to Lobby"})]})});const x=n>0?r[n-1]:null,F=r.length>0?n/r.length*100:0;return e.jsxs(l,{className:"h-screen flex flex-col bg-gray-900",children:[e.jsxs(v,{className:"flex items-center justify-between p-4",sx:{background:"rgba(255,255,255,0.95)",zIndex:10},children:[e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(p,{onClick:S,children:e.jsx(Q,{})}),e.jsx(t,{variant:"h5",className:"font-bold",children:"Game Replay"})]}),e.jsxs(l,{className:"text-right",children:[e.jsx(t,{variant:"h6",children:m.name}),e.jsxs(t,{variant:"body2",className:"text-gray-600",children:["Move ",n," of ",r.length]})]})]}),e.jsxs(l,{className:"flex-1 relative",children:[e.jsx(D,{pieces:R,cameraPreset:"isometric",showGrid:!0}),x&&e.jsxs(v,{className:"absolute top-4 left-4 p-3",sx:{background:"rgba(255,255,255,0.9)",minWidth:200},children:[e.jsxs(t,{variant:"h6",className:"mb-2",children:["Move ",n]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Player:"})," ",x.playerName]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Piece:"})," ",x.pieceType]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"From:"})," (",x.fromX,", ",x.fromY,")"]}),x.toX!==null&&x.toY!==null&&e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"To:"})," (",x.toX,", ",x.toY,")"]})]}),e.jsxs(v,{className:"absolute top-4 right-4 p-3",sx:{background:"rgba(255,255,255,0.9)",minWidth:250},children:[e.jsx(t,{variant:"h6",className:"mb-2",children:"Players"}),m.players.map(a=>e.jsxs(l,{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border",style:{backgroundColor:a.color}}),e.jsx(t,{variant:"body2",children:a.name})]},a.id)),m.winner&&e.jsx(l,{className:"mt-3 p-2 bg-green-100 rounded",children:e.jsxs(t,{variant:"body2",className:"font-semibold",children:["Winner: ",m.winner.name]})})]})]}),e.jsxs(v,{className:"p-4",sx:{background:"rgba(255,255,255,0.95)"},children:[e.jsx(l,{className:"mb-4",children:e.jsx(U,{variant:"determinate",value:F,sx:{height:8,borderRadius:4}})}),e.jsxs(l,{className:"flex items-center gap-4",children:[e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(p,{onClick:G,children:e.jsx(q,{})}),e.jsx(p,{onClick:A,disabled:n===0,children:e.jsx(H,{})}),e.jsx(p,{onClick:E,children:f?e.jsx(J,{}):e.jsx(V,{})}),e.jsx(p,{onClick:k,disabled:n>=r.length,children:e.jsx(Z,{})})]}),e.jsx(l,{className:"flex-1 mx-4",children:e.jsx(w,{value:n,onChange:L,min:0,max:r.length,step:1,marks:[{value:0,label:"Start"},{value:r.length,label:"End"}]})}),e.jsxs(l,{className:"w-32",children:[e.jsxs(t,{variant:"caption",className:"block",children:["Speed: ",(2e3/g).toFixed(1),"x"]}),e.jsx(w,{value:2e3/g,onChange:(a,s)=>T(2e3/s),min:.5,max:4,step:.5,size:"small"})]})]})]})]})};export{le as default};
//# sourceMappingURL=ReplayPage-BiEJW7vj.js.map
