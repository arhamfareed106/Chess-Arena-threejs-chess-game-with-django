import{j as e}from"./three-BQE6C20b.js";import{r as d}from"./vendor-CnEhrtKZ.js";import{a as F,u as W,n as z}from"./index-DyRg6-YS.js";import{G as D}from"./GameScene-CxlZgWho.js";import{P as $}from"./index-DpsEWzRx.js";import{g as K}from"./gameService-DBbfCwCN.js";import{a as n,d as O,B as o,t as v,f as u,o as Q,K as U,M as q,N as H,O as J,Q as V,U as Z,W as I}from"./ui-Cda-PtV-.js";const le=()=>{const{gameId:y}=F(),b=W(),[m,C]=d.useState(null),[r,M]=d.useState([]),[T,N]=d.useState([]),[R,X]=d.useState(!0),[t,p]=d.useState(0),[f,j]=d.useState(!1),[g,Y]=d.useState(1e3);d.useEffect(()=>{if(!y)return;(async()=>{var i;try{const s=await K.getGameReplay(y);C({id:s.game_id,name:`Replay of ${s.game_id.slice(0,8)}`,isPublic:!0,status:"finished",turnCount:0,noProgressTurns:0,currentTurnPlayerName:null,winnerName:s.winner,winner:s.winner,movesCount:((i=s.moves)==null?void 0:i.length)||0,players:s.players,moves:s.moves,createdAt:s.created_at,updatedAt:s.created_at,startedAt:s.created_at,finishedAt:s.finished_at}),M(s.moves||[]),P(s.players)}catch(s){console.error("Failed to load replay data:",s),z.error("Failed to load replay"),b("/")}finally{X(!1)}})()},[y,b]),d.useEffect(()=>{if(!f||t>=r.length){j(!1);return}const a=setTimeout(()=>{k()},g);return()=>clearTimeout(a)},[f,t,r.length,g]),d.useEffect(()=>{A(t)},[t,r]);const P=a=>{const i=[];a.forEach((s,l)=>{const h=l===0?1:6;for(let c=0;c<8;c++)i.push({id:`${s.id}-piece-${c}`,pieceType:$.TALENT,level:1,positionX:c,positionY:h,transformCount:0,temporaryBuffs:{},isActive:!0,ownerName:s.name,ownerColor:s.color,createdAt:"",updatedAt:""})}),N(i)},A=a=>{if(a===0){m!=null&&m.players&&P(m.players);return}N(i=>{const s=[...i],l=r[a-1];if(l){const h=s.findIndex(c=>c.positionX===l.fromX&&c.positionY===l.fromY);if(h!==-1&&l.toX!==null&&l.toY!==null){const c=s.findIndex(S=>S.positionX===l.toX&&S.positionY===l.toY);c!==-1&&s.splice(c,1),s[h]={...s[h],positionX:l.toX,positionY:l.toY}}}return s})},B=()=>{j(!f)},k=()=>{t<r.length&&p(a=>a+1)},E=()=>{t>0&&p(a=>a-1)},_=()=>{p(0),j(!1)},G=(a,i)=>{p(i),j(!1)},w=()=>{b("/")};if(R)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"loading-spinner mx-auto mb-4"}),e.jsx(n,{variant:"h6",className:"text-white",children:"Loading replay..."})]})});if(!m||r.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(n,{variant:"h5",className:"mb-4",children:"No replay data available"}),e.jsx(O,{onClick:w,children:"Return to Lobby"})]})});const x=t>0?r[t-1]:null,L=r.length>0?t/r.length*100:0;return e.jsxs(o,{className:"h-screen flex flex-col bg-gray-900",children:[e.jsxs(v,{className:"flex items-center justify-between p-4",sx:{background:"rgba(255,255,255,0.95)",zIndex:10},children:[e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(u,{onClick:w,children:e.jsx(Q,{})}),e.jsx(n,{variant:"h5",className:"font-bold",children:"Game Replay"})]}),e.jsxs(o,{className:"text-right",children:[e.jsx(n,{variant:"h6",children:m.name}),e.jsxs(n,{variant:"body2",className:"text-gray-600",children:["Move ",t," of ",r.length]})]})]}),e.jsxs(o,{className:"flex-1 relative",children:[e.jsx(D,{pieces:T,cameraPreset:"isometric",showGrid:!0}),x&&e.jsxs(v,{className:"absolute top-4 left-4 p-3",sx:{background:"rgba(255,255,255,0.9)",minWidth:200},children:[e.jsxs(n,{variant:"h6",className:"mb-2",children:["Move ",t]}),e.jsxs(n,{variant:"body2",children:[e.jsx("strong",{children:"Player:"})," ",x.playerName]}),e.jsxs(n,{variant:"body2",children:[e.jsx("strong",{children:"Piece:"})," ",x.pieceType]}),e.jsxs(n,{variant:"body2",children:[e.jsx("strong",{children:"From:"})," (",x.fromX,", ",x.fromY,")"]}),x.toX!==null&&x.toY!==null&&e.jsxs(n,{variant:"body2",children:[e.jsx("strong",{children:"To:"})," (",x.toX,", ",x.toY,")"]})]}),e.jsxs(v,{className:"absolute top-4 right-4 p-3",sx:{background:"rgba(255,255,255,0.9)",minWidth:250},children:[e.jsx(n,{variant:"h6",className:"mb-2",children:"Players"}),m.players.map(a=>e.jsxs(o,{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border",style:{backgroundColor:a.color}}),e.jsx(n,{variant:"body2",children:a.name})]},a.id)),m.winner&&e.jsx(o,{className:"mt-3 p-2 bg-green-100 rounded",children:e.jsxs(n,{variant:"body2",className:"font-semibold",children:["Winner: ",m.winner]})})]})]}),e.jsxs(v,{className:"p-4",sx:{background:"rgba(255,255,255,0.95)"},children:[e.jsx(o,{className:"mb-4",children:e.jsx(U,{variant:"determinate",value:L,sx:{height:8,borderRadius:4}})}),e.jsxs(o,{className:"flex items-center gap-4",children:[e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(u,{onClick:_,children:e.jsx(q,{})}),e.jsx(u,{onClick:E,disabled:t===0,children:e.jsx(H,{})}),e.jsx(u,{onClick:B,children:f?e.jsx(J,{}):e.jsx(V,{})}),e.jsx(u,{onClick:k,disabled:t>=r.length,children:e.jsx(Z,{})})]}),e.jsx(o,{className:"flex-1 mx-4",children:e.jsx(I,{value:t,onChange:G,min:0,max:r.length,step:1,marks:[{value:0,label:"Start"},{value:r.length,label:"End"}]})}),e.jsxs(o,{className:"w-32",children:[e.jsxs(n,{variant:"caption",className:"block",children:["Speed: ",(2e3/g).toFixed(1),"x"]}),e.jsx(I,{value:2e3/g,onChange:(a,i)=>Y(2e3/i),min:.5,max:4,step:.5,size:"small"})]})]})]})]})};export{le as default};
//# sourceMappingURL=ReplayPage-CmJI_SQx.js.map
